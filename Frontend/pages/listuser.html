<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>Quản lý người dùng</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/css/bootstrap.min.css">
    <style>
        body {
            background-color: #f8f9fa;
        }

        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: #007bff;
            color: white;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 22px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div class="back-btn" onclick="window.location.href='dashboard.html'">⟵</div>
    <div class="container mt-4">
        <h2 class="text-center">Quản lý người dùng</h2>

        <!-- BUTTON MORE -->
        <button class="btn btn-primary my-3" data-toggle="modal" data-target="#addModal">
            + Thêm nhân viên
        </button>

        <!-- TABLE -->
        <table class="table table-bordered mt-3">
            <thead class="thead-dark">
                <tr>
                    <th>ID</th>
                    <th>Họ tên</th>
                    <th>Username</th>
                    <th>Password</th>
                    <th>Vai trò</th>
                    <th>Hành động</th>
                </tr>
            </thead>
            <tbody id="userTable"></tbody>
        </table>
    </div>

    <!-- =============== MODAL MORE =============== -->
    <div class="modal fade" id="addModal">
        <div class="modal-dialog">
            <div class="modal-content">

                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Thêm nhân viên</h5>
                    <button class="close text-white" data-dismiss="modal">&times;</button>
                </div>

                <div class="modal-body">
                    <input id="addName" type="text" class="form-control mb-3" placeholder="Họ tên">
                    <input id="addUsername" type="text" class="form-control mb-3" placeholder="Username">
                    <input id="addPassword" type="password" class="form-control mb-3" placeholder="Password">
                    <select id="addRole" class="form-control">
                        <option>Quản lý</option>
                        <option>Nhân viên</option>
                        <option>Bếp</option>
                    </select>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-success" onclick="addUser()">Lưu</button>
                    <button class="btn btn-secondary" data-dismiss="modal">Hủy</button>
                </div>

            </div>
        </div>
    </div>

    <!-- =============== MODAL EDIT =============== -->
    <div class="modal fade" id="editModal">
        <div class="modal-dialog">
            <div class="modal-content">

                <div class="modal-header bg-warning">
                    <h5 class="modal-title">Sửa thông tin nhân viên</h5>
                    <button class="close" data-dismiss="modal">&times;</button>
                </div>

                <div class="modal-body">
                    <input id="editId" type="hidden">

                    <input id="editName" type="text" class="form-control mb-3" placeholder="Họ tên">

                    <select id="editRole" class="form-control mb-3">
                        <option>Quản lý</option>
                        <option>Nhân viên</option>
                        <option>Bếp</option>
                    </select>

                </div>

                <div class="modal-footer">
                    <button class="btn btn-success" onclick="updateUser()">Lưu thay đổi</button>
                    <button class="btn btn-secondary" data-dismiss="modal">Hủy</button>
                </div>

            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const API_URL = "http://localhost:3000/api/users";

        // ================== LOAD LIST ==================
        function loadUsers() {
            fetch(API_URL)
                .then(res => res.json())
                .then(data => {
                    let html = "";
                    data.forEach(u => {
                        html += `
                        <tr>
                            <td>${u.IDNV}</td>
                            <td>${u.TenNV}</td>
                            <td>${u.Username}</td>
                            <td>${u.PasswordHash}</td>
                            <td>${u.VaiTro}</td>
                            <td>
                                <button class="btn btn-sm btn-warning" onclick='openEditModal(${JSON.stringify(u)})'>Sửa</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteUser(${u.IDNV})">Xóa</button>
                            </td>
                        </tr>
                    `;
                    });
                    document.getElementById("userTable").innerHTML = html;
                })
                .catch(err => console.error("Lỗi load user:", err));
        }

        loadUsers();

        // ================== MORE ==================
        function addUser() {
            const payload = {
                TenNV: document.getElementById("addName").value,
                Username: document.getElementById("addUsername").value,
                PasswordHash: document.getElementById("addPassword").value,
                VaiTro: document.getElementById("addRole").value
            };

            fetch(API_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            })
                .then(res => res.json())
                .then(() => {
                    $("#addModal").modal("hide");
                    loadUsers();
                });
        }

        // ================== OPEN MODAL EDIT ==================
        function openEditModal(user) {
            document.getElementById("editId").value = user.IDNV;
            document.getElementById("editName").value = user.TenNV;
            document.getElementById("editRole").value = user.VaiTro;

            $("#editModal").modal("show");
        }

        // ================== UPDATE ==================
        function updateUser() {
            const id = document.getElementById("editId").value;

            const payload = {
                TenNV: document.getElementById("editName").value,
                VaiTro: document.getElementById("editRole").value
            };

            fetch(`${API_URL}/${id}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            })
                .then(res => res.json())
                .then(() => {
                    $("#editModal").modal("hide");
                    loadUsers();
                });
        }

        // ================== DELTE ==================
        function deleteUser(id) {
            if (confirm("Bạn có chắc muốn xóa nhân viên này?")) {
                fetch(`${API_URL}/${id}`, { method: "DELETE" })
                    .then(() => loadUsers());
            }
        }

    </script>

</body>

</html>