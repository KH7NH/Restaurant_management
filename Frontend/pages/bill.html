<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh s√°ch h√≥a ƒë∆°n</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="icon" type="image/png" href="../assets/images/logo.png">

    <style>
        body {
            background-color: #f8f9fa;
        }

        .bill-card {
            padding: 15px;
            margin-bottom: 12px;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
            transition: 0.2s;
        }

        .bill-card:hover {
            transform: scale(1.02);
            background: #f1f9ff;
        }

        .status {
            padding: 5px 10px;
            border-radius: 5px;
            color: white;
            font-size: 14px;
            display: inline-block;
        }

        .st-pending {
            background: #ffc107;
        }

        .st-done {
            background: #28a745;
        }

        .st-cancel {
            background: #dc3545;
        }

        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: #007bff;
            color: white;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 22px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div class="back-btn" onclick="window.location.href='dashboard.html'">‚üµ</div>
    <div class="container mt-4">
        <h2 class="text-center mb-4">üìÑ Danh s√°ch h√≥a ƒë∆°n</h2>
        <!-- Filter -->
        <div class="row mb-3">
            <div class="col-md-4 offset-md-4">
                <select id="filterStatus" class="form-control" onchange="loadBills()">
                    <option value="">T·∫•t c·∫£</option>
                    <option value="Ch·ªù x·ª≠ l√Ω">Ch·ªù x·ª≠ l√Ω</option>
                    <option value="Ho√†n th√†nh">Ho√†n th√†nh</option>
                    <option value="ƒê√£ h·ªßy">ƒê√£ h·ªßy</option>
                </select>
            </div>
        </div>

        <!-- List of invoices -->
        <div id="billList"></div>
    </div>

    <!-- Modal Invoice Details -->
    <div class="modal fade" id="detailModal">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">

                <div class="modal-header">
                    <h4 class="modal-title">Chi ti·∫øt h√≥a ƒë∆°n</h4>
                    <button type="button" class="close" data-dismiss="modal">√ó</button>
                </div>

                <div class="modal-body">
                    <div id="billDetail"></div>
                </div>

            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const API_ORDER = "http://localhost:3000/api/order";

        // LOAD INVOICE LIST
        async function loadBills() {
            const box = document.getElementById("billList");
            const filter = document.getElementById("filterStatus").value;

            box.innerHTML = "<p class='text-muted text-center'>ƒêang t·∫£i...</p>";

            try {
                const res = await fetch(API_ORDER);
                const data = await res.json();

                if (!Array.isArray(data) || data.length === 0) {
                    box.innerHTML = "<p class='text-center text-muted'>Kh√¥ng c√≥ h√≥a ƒë∆°n n√†o!</p>";
                    return;
                }

                // üü° L·ªçc theo tr·∫°ng th√°i (n·∫øu c√≥ ch·ªçn)
                const filtered = filter
                    ? data.filter(b => b.TrangThai === filter)
                    : data;

                if (filtered.length === 0) {
                    box.innerHTML = "<p class='text-center text-muted'>Kh√¥ng t√¨m th·∫•y h√≥a ƒë∆°n ph√π h·ª£p!</p>";
                    return;
                }

                let html = "";
                filtered.forEach(bill => {
                    const statusClass =
                        bill.TrangThai === "Ho√†n th√†nh" ? "st-done" :
                            bill.TrangThai === "ƒê√£ h·ªßy" ? "st-cancel" : "st-pending";

                    html += `
                <div class="bill-card" onclick="viewDetail(${bill.IDDonHang})">
                    <h5>üßæ H√≥a ƒë∆°n #${bill.IDDonHang}</h5>

                    <p>üë§ Kh√°ch: <b>${bill.TenKhachHang}</b></p>

                    <p>üí∞ T·ªïng ti·ªÅn:
                        <b>${bill.TongTien?.toLocaleString("vi-VN")}ƒë</b>
                    </p>

                    <p>üìÖ Ng√†y: ${new Date(bill.Ngay).toLocaleString("vi-VN")}</p>

                    <p>üìå Tr·∫°ng th√°i:
                        <span class="status ${statusClass}">
                            ${bill.TrangThai ?? "Ch∆∞a c·∫≠p nh·∫≠t"}
                        </span>
                    </p>
                </div>
            `;
                });

                box.innerHTML = html;

            } catch (err) {
                console.error(err);
                box.innerHTML = "<p class='text-center text-danger'>L·ªói t·∫£i d·ªØ li·ªáu!</p>";
            }
        }

        // VIEW DETAILS OF AN INVOICE
        async function viewDetail(id) {
            try {
                const res = await fetch(`${API_ORDER}/${id}`);
                const data = await res.json();

                const statusClass =
                    data.DonHang.TrangThai === "Ho√†n th√†nh" ? "st-done" :
                        data.DonHang.TrangThai === "ƒê√£ h·ªßy" ? "st-cancel" : "st-pending";

                let html = `
                    <h5>üßæ H√≥a ƒë∆°n #${id}</h5>

                    <p>üë§ Kh√°ch h√†ng: <b>${data.DonHang.TenKhachHang}</b></p>

                    <p>üïí Ng√†y t·∫°o: 
                        ${new Date(data.DonHang.Ngay).toLocaleString("vi-VN")}
                    </p>

                    <p>üìå Tr·∫°ng th√°i hi·ªán t·∫°i:
                        <span class="status ${statusClass}">
                            ${data.DonHang.TrangThai}
                        </span>
                    </p>

                    <label>C·∫≠p nh·∫≠t tr·∫°ng th√°i</label>
                    <select id="newStatus" class="form-control mb-3">
                        <option value="Ch·ªù x·ª≠ l√Ω">Ch·ªù x·ª≠ l√Ω</option>
                        <option value="Ho√†n th√†nh">Ho√†n th√†nh</option>
                        <option value="ƒê√£ h·ªßy">ƒê√£ h·ªßy</option>
                    </select>

                    <button class="btn btn-primary" onclick="saveStatus(${id})">
                        ‚úî L∆∞u tr·∫°ng th√°i
                    </button>

                    <p>üìù Ghi ch√∫: ${data.DonHang.GhiChu ?? "Kh√¥ng c√≥"}</p>

                    <hr>

                    <h5>üçú Chi ti·∫øt m√≥n ƒÉn</h5>
                `;

                data.ChiTiet.forEach(item => {
                    html += `
                        <div class="border p-2 mb-2 rounded">
                            <h6>${item.TenMA}</h6>
                            <p>Gi√°: ${item.Gia.toLocaleString("vi-VN")}ƒë</p>
                            <p>S·ªë l∆∞·ª£ng: ${item.SoLuong}</p>
                            <p>Th√†nh ti·ªÅn: <b>${(item.Gia * item.SoLuong).toLocaleString("vi-VN")}ƒë</b></p>
                        </div>
                    `;
                });

                html += `
                    <hr>
                    <h5>üí≥ Thanh to√°n</h5>
                    <p>Ph∆∞∆°ng th·ª©c: <b>${data.HoaDon?.PhuongThucTT}</b></p>
                    <p>T·ªïng ti·ªÅn: 
                        <b style="color:red;">${data.HoaDon?.TongTien.toLocaleString("vi-VN")}ƒë</b>
                    </p>
                `;

                document.getElementById("billDetail").innerHTML = html;

                $("#detailModal").modal("show");

            } catch (err) {
                console.error(err);
                alert("L·ªói t·∫£i chi ti·∫øt h√≥a ƒë∆°n!");
            }

            document.getElementById("newStatus").value = data.DonHang.TrangThai;
        }

        loadBills();

        async function saveStatus(id) {
            const newStatus = document.getElementById("newStatus").value;

            try {
                const res = await fetch(`http://localhost:3000/api/order/status/${id}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ TrangThai: newStatus })
                });

                const data = await res.json();

                if (!res.ok) {
                    return alert("‚ùå L·ªói: " + data.message);
                }

                alert("‚úî C·∫≠p nh·∫≠t th√†nh c√¥ng!");

                $("#detailModal").modal("hide");
                loadBills(); // reload invoice list

            } catch (err) {
                console.error(err);
                alert("Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i!");
            }
        }
    </script>

</body>

</html>